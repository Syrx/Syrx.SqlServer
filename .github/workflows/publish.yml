# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json


name: publish
on:
  workflow_dispatch:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - '*'
  release:
    types:
      - published

env:
  NuGetDirectory: ${{ github.workspace }}/src/*/bin/Release/

defaults:
  run:
    shell: pwsh

jobs:
  create_nuget:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: [ '8.0.x' ]
    steps:
    - uses: actions/checkout@v5
      with:
        submodules: recursive
    - name: Initialize submodules
      run: git submodule update --init --recursive
    - uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
    - name: Build solution
      run: dotnet build --configuration Release
    - uses: actions/upload-artifact@v4
      with:
        name: nuget
        if-no-files-found: error
        retention-days: 7
        path: ${{ env.NuGetDirectory }}/*.nupkg

  validate_nuget:
    runs-on: ubuntu-latest
    needs: [ create_nuget ]
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v5
      - uses: actions/download-artifact@v5
        with:
          name: nuget
          path: ${{ env.NuGetDirectory }}

  run_test:
    runs-on: ubuntu-latest
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: YourStrong!Passw0rd
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd="/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong!Passw0rd -C -Q 'SELECT 1'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
    - uses: actions/checkout@v5
      with:
        submodules: recursive
    - name: Initialize submodules
      run: git submodule update --init --recursive
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
    - name: Wait for SQL Server to be ready
      run: |
        Write-Host "Waiting for SQL Server to be ready..."
        for ($i = 1; $i -le 30; $i++) {
          try {
            /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong!Passw0rd -C -Q "SELECT 1"
            if ($LASTEXITCODE -eq 0) {
              Write-Host "SQL Server is ready!"
              break
            }
          } catch {
            # Continue with the loop
          }
          Write-Host "Attempt $i`: SQL Server not ready yet, waiting..."
          Start-Sleep -Seconds 2
        }
    - name: Setup SQL Server database schema
      run: |
        $scriptPath = "tests/integration/Syrx.SqlServer.Tests.Integration/Docker/init-scripts"
        if (Test-Path $scriptPath) {
          Get-ChildItem -Path $scriptPath -Filter "*.sql" | Sort-Object Name | ForEach-Object {
            Write-Host "Running script: $($_.Name)"
            /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong!Passw0rd -C -i $_.FullName
          }
        }
    - name: Run tests (.NET 8.0)
      run: dotnet test --configuration Release --framework net8.0
    - name: Run tests (.NET 9.0)
      run: dotnet test --configuration Release --framework net9.0

  deploy:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: [ validate_nuget, run_test ]
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: nuget
          path: ${{ env.NuGetDirectory }}
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v5
      - name: Publish NuGet package
        run: |
          Get-ChildItem -Path . -Recurse -Include *.nupkg | ForEach-Object {
            $nupkgPath = $_.FullName
            Write-Host "Pushing $nupkgPath"
            dotnet nuget push $nupkgPath --api-key "${{ secrets.NUGET_API_KEY }}" --source https://api.nuget.org/v3/index.json --skip-duplicate
          }


          
